import{A as R,b as rr,C as Q}from"./DyCfErH6.js";import{X as V,Z as Y,v as er,c as Z,ag as U,Y as j,E as X,ad as N,P as A,f as $,g as tr,b as ir,a as nr,T as ar,x as sr,U as or}from"./BI0F1cZy.js";import{F as lr}from"./Cm24sjfI.js";import{f as G}from"./VyEV7r3X.js";import{E as m,n as K,a2 as ur}from"./D-d7HeIt.js";const wr={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},br=(r,e,t)=>{let s=[];return{updatedProducts:r.map(i=>{if(i._id===t._id){if(e>i.max)return i.qty=i.qty,s.push(`A maximum of ${i.max} units of ${i.name} only can be purchased`),i;if(e>i.price.availableQuantity&&i.price.trackInventory&&!i.price.allowOutOfStockPurchases)return i.qty=i.qty,s.push(`Only ${i.price.availableQuantity} units of ${i.name} are in stock`),i;i.qty=e}return i}),errorMessages:s}},_r=r=>{var e,t,s;return((e=r==null?void 0:r.price)==null?void 0:e.availableQuantity)<=0&&((t=r==null?void 0:r.price)==null?void 0:t.trackInventory)&&!((s=r==null?void 0:r.price)!=null&&s.allowOutOfStockPurchases)},Er=(r,e)=>e.find(t=>t._id===r.id),dr=async({contactId:r,domain:e,pageUrl:t,locationId:s,productPreviewList:l,isCouponApplied:i,couponCode:n,couponSessionId:a,store:f,subType:c,traceId:S="",reCaptchaToken:o,isEcommercePurchase:I,shippingRateId:d,toZip:v,toState:O,toCountry:P,shippingCarrierRateId:F,note:k,separateBillingAddress:T})=>{var w,b,_,g;try{const h=m("msgsndr_id").value,W=m("am_id").value,x=m("am_fingerprint").value,M=f.funnelName||"funnel";e||(e=window.location.hostname,t=window.location.pathname);const{funnelPageId:q,funnelId:z,stepId:L}=f,C={altId:s,altType:"location",shippingRateId:d,shippingCarrierRateId:F,contactId:r,source:{type:f.pageType===N.FUNNEL?N.FUNNEL:N.WEBSITE,subType:c,id:z,name:M,meta:{stepId:L,pageId:q,domain:e,pageUrl:t,affiliateManager:{id:W,fingerprint:x}}},products:l.map(E=>({id:I?E.selectedPrice._id:E._id,qty:E.qty||E.quantity})),fingerprint:h,trackingId:Z(),traceId:S,toZip:v,toState:O,toCountry:P,customerNote:k,separateBillingAddress:T};i&&(C.couponCode=n,C.couponSessionId=a),o&&(C.captchaToken=o);const y=await A.createOrder(C);if(!((w=y.order)==null?void 0:w._id))throw new Error("Something went wrong while creating order. Please try again later.");return y}catch(h){return console.error(h),{error:!0,message:(_=(b=h==null?void 0:h.response)==null?void 0:b._data)==null?void 0:_.message,status:(g=h==null?void 0:h.response)==null?void 0:g.status}}},gr=async(r,e,t,s,l,i,n)=>{var J,E,B;const a=m("msgsndr_id").value,f=m("am_id").value,c=m("am_fingerprint").value,S=tr(r.locationId),o=ir(r.locationId),I=nr(),d=r.funnelName||"funnel";let{domain:v,page_url:O}=e.query;v||(v=window.location.hostname,O=window.location.pathname);const{funnelPageId:P,funnelId:F,stepId:k}=r,T={eventType:"optin",domainName:v,pageUrl:O,funnelId:F,pageId:P,stepId:k},{address:w,country:b,state:_,city:g,zipcode:h,fullName:W,phoneNumber:x,emailId:M,companyName:q}=t,z={addressLine1:w,country:b||s,state:_,city:g,zip:h};I.medium=ar.OrderForm,I.mediumId=T.stepId;const L=sr();I.fbEventId=L;const C={lead:!0,eventData:I,source:d,pageId:P,funnelId:F,sessionId:S,funnelEventData:T,sessionFingerprint:o||null},y={locationId:r.locationId,name:W,phone:x,email:(M==null?void 0:M.toLowerCase())||"",companyName:q,address:z,attribution:C,timezone:or(),amId:String(f),amFingerprint:c,orderFormType:"one_step_form_submission",captchaToken:l,billingAddress:n};i.enableStickyContact&&(y.attribution.fingerprint=a,y.attribution.funnelEventData.fingerprint=a),i.enableForceCreate&&(y.attribution.forceCreate=!0),i.enableEmailValidation&&(y.attribution.session_d=Number(i.enableEmailValidation)||0);try{const u=await lr.createContact(y);if(!u)throw new Error("Something went wrong. Please try again later.");if(u.fbEventId=L,a!==u.fingerprint){r.fingerprint=a;const D=m("msgsndr_id",{path:"/",maxAge:31536e3});D.value=u.fingerprint}Z();const p=j(u);X("_ud",p),K(()=>{G("track","SubmitApplication")});let H=u.sessionFingerprint;return I&&(V({sessionId:u.sessionId||null,locationId:r.locationId}),H&&Y(r.locationId,H)),u}catch(u){return console.error(u),{error:!0,message:(E=(J=u==null?void 0:u.response)==null?void 0:J._data)==null?void 0:E.message,status:(B=u==null?void 0:u.response)==null?void 0:B.status}}},Or=async(r,e,t,s,l,i,n,a,f,c,S,o,I,d,v,O,P,F,k,T)=>{var w,b,_;if((!n||!n.id)&&(n=await gr(r,e,t,s,l,i,F),l=void 0),n!=null&&n.error){let g={};return(n==null?void 0:n.status)===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0},g):(g={error:!0,processingPayment:!1,cardErrorMsg:n.message||"We're sorry, but something went wrong. Please try again"},g)}if((n.id&&!a||!((w=a==null?void 0:a.order)!=null&&w._id))&&(a=await dr({contactId:n==null?void 0:n.id,domain:r.domain,pageUrl:r.pageUrl,locationId:r.locationId,productPreviewList:c,isCouponApplied:f,couponCode:o,couponSessionId:S,store:r,subType:d,traceId:n==null?void 0:n.traceId,reCaptchaToken:l,isEcommercePurchase:I,shippingRateId:v,toZip:(t==null?void 0:t.zipcode)??((b=t.address)==null?void 0:b.zip),toState:O,toCountry:(t==null?void 0:t.country)??((_=t.address)==null?void 0:_.country),shippingCarrierRateId:P,note:k,separateBillingAddress:T}),l=void 0),a!=null&&a.error){let g={};return a.status===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:n},g):(g={error:!0,processingPayment:!1,contactResponse:n,cardErrorMsg:a.message||"We're sorry, but something went wrong. Please try again"},g)}return(a==null?void 0:a.success)===!1?{error:!0,cardErrorMsg:a==null?void 0:a.message,processingPayment:!1}:(sessionStorage.setItem("orderResponse",JSON.stringify(a)),d!=U.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),sessionStorage.setItem("orderResponse",JSON.stringify(a)),d!=U.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),sessionStorage.setItem("orderResponse",JSON.stringify(a)),d!=U.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(n)),{contactResponse:n,orderResponse:a,reCaptchaToken:l})},mr=(r,e,t,s)=>{if(Z()!=(t==null?void 0:t.verifiedTrackingId)){const i=m("tr",{path:"/",maxAge:900});i.value=t==null?void 0:t.verifiedTrackingId}if(s!==U.TWO_STEP_ORDER_FORM){if(r.fingerprint!==e){const n=m("msgsndr_id",{path:"/",maxAge:31536e3});n.value=r.fingerprint}const i=j(r);X("_ud",i)}if(r.fbEventId){let i=r.fbEventId;K(()=>{G("track","OrderFormPurchase",i)})}else console.warn("Facebook event Id missing from attribution!")},Pr=async(r,e,t,s,l)=>{let i=!1,n="";if(e!=null&&e.message&&!(e!=null&&e.success))throw new Error(e.message);t===R&&(e!=null&&e.pendingConfirmation)&&(i=!0,n="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const a=m("msgsndr_id").value;await mr(r,a,e,l);const f=m("provider");f.value=t===rr?"pp":t===Q?Q:"cc",await fr({sessionId:r.sessionId,sessionFingerprint:e==null?void 0:e.sessionFingerprint},s);const c=sessionStorage.getItem("redirect");if(cr(s),c){sessionStorage.removeItem("redirect"),window.location.href=c;return}return{paymentResponseData:e,authorizeOrderPendingConfirmation:i,authorizeOrderAlertMsg:n}},fr=(r,e)=>{r&&r.sessionId&&(V({sessionId:r.sessionId||null,locationId:e}),r.sessionFingerprint&&Y(e,r.sessionFingerprint))},Fr=r=>{var t;(!(r.keyCode>=48&&r.keyCode<=57||r.keyCode>=96&&r.keyCode<=105)||!/^\d{0,2}$/.test((t=r.target)==null?void 0:t.value))&&r.keyCode!==8&&r.preventDefault()},cr=r=>{const e=er();return sessionStorage.setItem(`couponSessionId_${r}`,e),e},Tr=async(r,e,t="",s,l,i)=>{var n,a,f,c,S;try{const o=$(),I={altId:o.value.locationId,altType:"location",couponCode:t,source:{type:o.value.pageType===N.FUNNEL?N.FUNNEL:N.WEBSITE,subType:e,id:o.value.funnelId,name:o.value.funnelName,meta:{stepId:o.value.stepId,pageId:o.value.funnelPageId,domain:o.value.domain,pageUrl:o.value.pageUrl,affiliateManager:{id:m("am_id").value,fingerprint:m("msgsndr_id").value}}},products:r,toCountry:s,toState:l,toZip:i},d=await A.getAmountSummary(I);return{total:d.summary.total,subtotal:d.summary.subtotal,taxSummary:d.summary.taxSummary,subtotalWithDiscount:d.summary.subtotalWithDiscount,futureRecurringPaymentAmount:(n=d.recurringSummary)==null?void 0:n.subtotalWithDiscount}}catch(o){return console.error(o),{error:!0,message:((f=(a=o==null?void 0:o.response)==null?void 0:a._data)==null?void 0:f.message)||"Something went wrong while fetching order total. Please try again later",status:(S=(c=o==null?void 0:o.response)==null?void 0:c._data)==null?void 0:S.status}}},Cr=async(r,e)=>{const t=await A.getLastPaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e});return{paymentProvider:t==null?void 0:t.paymentProvider,paymentMethod:t==null?void 0:t.paymentMethod}},Nr=async(r,e)=>await A.getLastSquarePaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e}),kr=(r,e,t,s)=>{const l=e<=0&&!t,i=t&&s<=0,n=l||i;return!!(r&&n||n)},Mr=async()=>{const r=$();try{const e=await A.getStatesInformation();if(e&&e.error)throw ur(e.error);r.value.countryList=(e==null?void 0:e.data)??[]}catch(e){console.error("Failed to fetch country list",e)}},Ar=r=>$().value.countryList.find(t=>t.code===r),Lr=(r,e,t)=>{if(r.startsWith("+44")&&e.match(/^07\d*$/)){const s=r.replace("+44 1534","+44").replace("1534","");return window.libphonenumber.parsePhoneNumberFromString(s,"JE").formatInternational()}return t.formatInternational()};export{Tr as a,Mr as b,cr as c,dr as d,Nr as e,Cr as f,Ar as g,Pr as h,Lr as i,_r as j,Er as k,br as l,Or as m,Fr as n,kr as p,wr as s};
